var app = angular.module('DRApp', []).directive('ngdrapp', function() {

	return {

		controllerAs: 'drapp',
		controller: ['$http', function charsCtrl($http) {
			this.$http = $http;

			var self = this;
			self.chars = [];

			self.dystopia = [];

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// VIEW ALL STRAINS ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			this.getDystopia = function() {
				console.log('getting all strains');

				// ajax get request to /dystopia - from dr_app.js API
				self.$http.get('/dystopia').then(function(response) {
					self.dystopia = response.data;
				});

			};

			self.getDystopia()

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// VIEW ALL CHARACTERs /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			this.getChars = function() {
				console.log('getting all chars');
				// ajax get request to /chars
				self.$http.get('/chars').then(function(response) {
					self.chars = response.data;
				});

				return self.chars;

			};

			self.getChars()


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CHARACTER ROUTES ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ADD CHARACTER ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			this.addChar = function() {
				self.$http.post('/chars', {name: this.formCharName, strain: this.formCharStrain, backstory: this.formCharBackstory, imgurl: this.formCharimgURL}).then(function success(response) {
					self.chars.push(response.data);
					self.formCharName = '';
					self.formCharimgURL = '';
					self.formCharBackstory = '';

				}, function error() {
					console.log('error');
				});
			}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EDIT CHARACTER //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			this.populateForm = function(char) {
// POPULATE FORM =====================================//
				self.formCharId = char._id;
				self.formCharName = char.name;
				self.formCharStrain = char.strain;
				self.formCharBackstory = char.backstory;
				self.formCharimgURL = char.imgURL;

			};

// THEN SAVE CHARACTER ================================//
			this.editChar = function() {
				var id = this.formCharId;
				self.$http.put('/chars/' + id, {name: this.formCharName, strain: this.formCharStrain, backstory: this.formCharBackstory, imgurl: this.formCharimgURL }).then(function success (response) {
					console.log(response);
					self.getChars();

// EMPTY FORM ========================================//
					self.formCharId = '';
					self.formCharName = '';
					self.formCharBackstory = '';
					self.formCharimgURL = '';
				}, function error() {
					console.log('error');
				});
			}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DELETE CHARACTER ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

			this.deleteChar = function(char) {
				// Now that it's populated
				var id = char._id;
				self.$http.delete('/chars/' + id).then(function success (response) {
					console.log(response);
					self.getChars();
				}, function error() {
					console.log('error');
				});
			}

		}] // close controller

	} // close return object

}) // close directive

app.filter('break', function(){

	return function(str) {
		var newStr = str.replace('<br>', '"+<br>+"')

		return newStr
	}

})

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CUSTOM ANGULAR FILTERS //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

app.filter('unsafe', function($sce) {
	return function(val) {
		return $sce.trustAsHtml(val);
	};
});

app.filter('nospace', function () {
    return function (value) {
        return (!value) ? '' : value.replace(/ /g, '');
    };
});
